"use strict";require(["esri/Map","esri/views/MapView","esri/layers/FeatureLayer","esri/PopupTemplate","esri/widgets/Legend","esri/widgets/Compass","esri/widgets/Compass/CompassViewModel","esri/widgets/Home","esri/widgets/Home/HomeViewModel","esri/widgets/BasemapToggle","esri/widgets/Popup","esri/tasks/QueryTask","esri/tasks/support/Query","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleMarkerSymbol","esri/layers/GraphicsLayer","esri/Graphic","esri/geometry/Point","esri/renderers/SimpleRenderer","esri/renderers/ClassBreaksRenderer","dojo/domReady!"],function(e,t,r,i,o,n,a,s,c,d,l,u,v,h,p,f,y,w,b,g){var m=new e({basemap:"oceans"}),k=new t({container:"map-container",map:m,zoom:9,center:[121,33]});k.then(function(){function e(e,t){var r='<table class="ui celled table"  data-fid="{FID}"><tbody><tr><td class="projects">'+e+'项目数量</td><td>{数量}<a href="#" class="projects-link" data-zone={FID} data-field='+t+" data-val="+e+' onclick="showProjects()"> 点击查看项目详情</a></td></tr><tr><td>配号来源</td><td>{配号来源}</td></tr><tr><td>用海一级类</td><td>{用海一级类}</td></tr><tr><td>用海二级类</td><td>{用海二级类}</td></tr><tr><td>用海方式</td><td>{用海方式}</td></tr></tbody></table>';return new i({title:"区域ID: {FID}",content:r})}function t(e,t,i,o){var n=i+": "+t+"项目",a=L[(o-1)%7],s=C[Math.floor((o-1)/7)];$('.checkbox[data-field="'+i+'"][data-val="'+t+'"]').find(".symbol").css({background:"rgba("+a.toString()+")"});var c=new b({symbol:new p({color:a,outline:{color:s,width:2}}),visualVariables:[P]}),d=new r({id:o,title:n,source:e,fields:U,objectIdField:"ObjectID",renderer:c,geometryType:"polygon"});return m.add(d),m.reorder(d,99),d}function l(e,t){return new Promise(function(r,i){var o="/mysql/zone_count?field="+t+"&val="+e;$.get(o,function(e){r(e)})})}function u(e,t,r){var i=t.features,o=[];return i.forEach(function(t,i){t.popupTemplate=r;var n=!0,a=!1,s=void 0;try{for(var c,d=e[Symbol.iterator]();!(n=(c=d.next()).done);n=!0){var l=c.value;l.zone==t.attributes.FID&&(t.attributes["数量"]=l.count,o.push(t))}}catch(u){a=!0,s=u}finally{try{!n&&d["return"]&&d["return"]()}finally{if(a)throw s}}}),o}function h(){function e(e,t,r){return $("<a>").attr({"class":"result","data-popid":r}).append($("<div>").attr("class","content").append($("<div>").attr("class","title").text(e)).append($("<div>").attr("class","description").text(t))).click(function(){var e=$(this).data("popid");console.log(q.inviewIndex);var t=S[q.inviewIndex],i=new v;i.where="FID = "+e,i.returnGeometry=!0,i.outFields=["*"],m.reorder(t,100),t.queryFeatures(i).then(function(e){console.log(e),k.popup.open({features:e.features,location:e.features[0].geometry.centroid})}),showProj(r)})}var t=$("#searchResult.results"),r=t.find(".projects");r.hide(),r.find(".result").remove();var i=t.find(".zones");i.hide(),i.find(".result").remove(),t.append('<div class="ui segment"><div class="ui active inverted dimmer"><div class="ui loader"></div></div><p></p></div>'),t.addClass("visible");var o=$('input[name="search"');$("i.icon.remove").show(),$("i.icon.search").hide(),$.get("/mysql/search?q="+o.val(),function(o){t.find(".segment").remove(),console.log(o.rows[0].length),console.log(o.rows[1].length);for(var n in o.rows[0])if(5>n){var a=o.rows[0][n];r.show(),$("a.csv1").show();var s="";for(var c in a)s=s+c+": "+a[c]+", ";s=s.substring(0,54)+"...",r.append(e(a["项目名称"],s,a["确权区域ID"]))}for(var d in o.rows[1])if(5>d){var a=o.rows[1][d];i.show(),$("a.csv2").show();var s="";for(var l in a)"init_date"==l&&(a[l]=a[l].substring(0,10)),s=s+l+": "+a[l]+", ";s=s.substring(0,48)+"...",i.append(e(a.id,s,a.id))}var u=t.find(".download-results"),v=o.csvs.split(",");u.find(".csv1").attr("href","/mysql/csv/"+v[0]),u.find(".csv2").attr("href","/mysql/csv/"+v[1]),u.show(),O.show(o.rows[0],o.rows[1])})}function f(){$(this).hasClass("active")?clear():(V.setUp($(this)),$(this).unbind("click",f),$(this).find(".checkbox.allin").checkbox("check"))}$('input[name="search"').change(h),$("i.icon.search").click(h);var y='<table class="ui celled table"  data-fid="{FID}"><tbody><tr><td>区域ID</td><td>{FID}</td></tr><tr><td>配号来源</td><td>{配号来源}</td></tr><tr><td>用海一级类</td><td>{用海一级类}</td></tr><tr><td>用海二级类</td><td>{用海二级类}</td></tr><tr><td>用海方式</td><td>{用海方式}</td></tr><tr><td class="projects">项目</td><td>{数量}<a href="#" class="projects-link" data-zone={FID} onclick="showProjects()">点击查看项目详情</a></td></tr></tbody></table>',w='<table class="ui celled table"  data-fid="{FID}"><tbody><tr><td class="projects">搜索结果项目数量</td><td>{数量}<a href="#" class="projects-link" data-zone={FID} onclick="showProjects()"> 点击查看项目详情</a></td></tr><tr><td class="projects">项目平均相关程度</td><td>{相关程度}</td></tr><tr><td>区域ID</td><td>{FID}</td></tr><tr><td>配号来源</td><td>{配号来源}</td></tr><tr><td>用海一级类</td><td>{用海一级类}</td></tr><tr><td>用海二级类</td><td>{用海二级类}</td></tr><tr><td>用海方式</td><td>{用海方式}</td></tr></tbody></table>',g=new n({viewModel:new a({view:k})},"compass");g.startup();var x=new s({viewModel:new c({view:k})},"home");x.startup();var I=new d({view:k,nextBasemap:"hybrid"},"basemap");I.startup();var D=new o({view:k});D.startup(),k.ui.add(D,"bottom-right");var F=new r({id:"base",url:"http://localhost:6080/arcgis/rest/services/区域/MapServer/0"});m.add(F),m.reorder(F,0);for(var j={on:!0,toggle:function(){this.on?m.remove(F):(m.add(F),m.reorder(F,0)),this.on=!this.on}},z=["功能区划","确权数据","确权数据--配号来源","确权数据--用海一级类","确权数据--用海二级类","确权数据--用海方式"],S=[],T=1;6>T;T++){var M=new r({id:z[T],outFields:["*"],url:"http://localhost:6080/arcgis/rest/services/用海信息/MapServer/"+T,popupTemplate:new i({title:"区域ID: {FID}",content:y})});1==T&&m.add(M),S[T]=M}var q={inviewIndex:1,on:!0,switchTo:function(e){e!==this.inviewIndex&&(m.remove(S[this.inviewIndex]),m.add(S[e]),m.reorder(S[e],1),this.inviewIndex=e)},toggle:function(){this.on?(m.remove(S[this.inviewIndex]),this.on=!1):(m.add(S[this.inviewIndex]),m.reorder(S[this.inviewIndex],1),this.on=!0)}},L=[[26,59,180,.7],[155,45,95,.7],[26,119,80,.7],[126,119,80,.7],[176,189,140,.7],[49,145,85,.7],[26,119,180,.7]],C=[[255,255,255,.6],[26,59,180,.6],[155,45,95,.6],[26,119,80,.6],[126,119,80,.6],[26,119,180,.6]],P={type:"size",field:"数量",valueUnit:"unknown",stops:[{value:1,size:8},{value:2,size:24},{value:3,size:36},{value:4,size:42}]},U=[{name:"ObjectID",alias:"ObjectID",type:"oid"},{name:"数量",alias:"数量",type:"double"},{name:"相关程度",alias:"相关程度",type:"number"}].concat(S[1].fields),V=function(){function r(e){j.on&&$("input.toggle.toggle-zoning").click(),q.on&&$("input.toggle.toggle-auth").click();var t=e.data("type"),r=e.next(".content");r.find('.vs-selection input[type="checkbox"]').each(function(){if("全部"!==$(this).val()){d++;var e=d;i($(this).val(),t,e),$(this).attr("data-id",e)}})}function i(r,i,o){var n=e(r,i);l(r,i).then(function(e){s.queryFeatures().then(function(s){a[o]=t(u(e,s,n),r,i,o),c.push(o)})})}function o(e){for(var t in a)t==e&&m.add(a[t])}function n(e){var t=!0,r=!1,i=void 0;try{for(var o,n=c[Symbol.iterator]();!(t=(o=n.next()).done);t=!0){var s=o.value;s==e&&m.remove(a[s])}}catch(d){r=!0,i=d}finally{try{!t&&n["return"]&&n["return"]()}finally{if(r)throw i}}}var a={},s=S[1],c=[],d=0;return{setUp:r,addVsLyr:i,addLyr:o,removeLyr:n}}(),O=function(){function e(e){var t="用海项目搜索结果",i=L[5],o=C[0],a=new b({symbol:new p({color:i,outline:{color:o,width:2}}),visualVariables:[P,s]});n=new r({title:t,source:e,fields:U,objectIdField:"ObjectID",renderer:a,geometryType:"polygon"}),m.add(n),m.reorder(n,99)}function t(e){var t="确权区域搜索结果";a=new r({title:t,source:e,fields:U,objectIdField:"ObjectID",geometryType:"polygon"}),m.add(a),m.reorder(a,1)}function i(r,i){o(),$(".vs-selection .checkbox.allin").checkbox("uncheck"),j.on&&$("input.toggle.toggle-zoning").click(),q.on&&$("input.toggle.toggle-auth").click(),S[1].queryFeatures().then(function(o){var n=o.features,a=[],s=[];n.forEach(function(e,t){var o=!0,n=!1,c=void 0;try{for(var d,l=i[Symbol.iterator]();!(o=(d=l.next()).done);o=!0){var u=d.value;u.id==e.attributes.FID&&s.push(e)}}catch(v){n=!0,c=v}finally{try{!o&&l["return"]&&l["return"]()}finally{if(n)throw c}}var h=0,p=0,f=!0,y=!1,b=void 0;try{for(var g,m=r[Symbol.iterator]();!(f=(g=m.next()).done);f=!0){var k=g.value;k["确权区域ID"]==e.attributes.FID&&(h+=k.relevance,p++)}}catch(v){y=!0,b=v}finally{try{!f&&m["return"]&&m["return"]()}finally{if(y)throw b}}p&&(e.attributes["数量"]=p,e.attributes["相关程度"]=h/p,e.popupTemplate.content=w,a.push(e))}),t(s),e(a)})}function o(){m.remove(n),m.remove(a),n={},a={}}var n={},a={},s={type:"opacity",field:"相关程度",valueUnit:"unknown",stops:[{value:1e-10,opacity:.01},{value:1e-7,opacity:.05},{value:2e-7,opacity:.1},{value:3e-7,opacity:.2},{value:3e-6,opacity:.4},{value:.001,opacity:.5},{value:.01,opacity:.7},{value:.1,opacity:.8},{value:1,opacity:1}]};return{show:i,clear:o}}();$("input.toggle.toggle-zoning").change(function(){j.toggle()}),$("input.toggle.toggle-auth").change(function(){q.toggle()}),$("select[name=authLyr]").change(function(){q.switchTo($(this).val())}),$("#searchDiv i.icon.remove").click(O.clear),$(".title.item.statistic.proj").click(f),$(".vs-selection .checkbox.allin").checkbox().checkbox({onChecked:function(){var e=$(this).parent(".checkbox").parent(".vs-selection");e.find(".checkbox:not(.allin)").checkbox("check")},onUnchecked:function(){var e=$(this).parent(".checkbox").parent(".vs-selection");e.find(".checkbox:not(.allin)").checkbox("uncheck")}}).checkbox("check"),$(".vs-selection .checkbox:not(.allin)").checkbox().checkbox({onChecked:function(){V.addLyr($(this).data("id"))},onUnchecked:function(){V.removeLyr($(this).data("id"))}}).checkbox("check")})});
//# sourceMappingURL=d:/inetpub/wwwroot/javascripts/maps/core.babeled.min.js.map
