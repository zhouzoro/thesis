{"version":3,"sources":["core.babeled.min.js","core.babeled.js"],"names":["require","Map","MapView","FeatureLayer","PopupTemplate","Legend","Compass","CompassVM","Home","HomeVM","BasemapToggle","Popup","QueryTask","Query","SimpleFillSymbol","SimpleMarkerSymbol","GraphicsLayer","Graphic","Point","SimpleRenderer","ClassBreaksRenderer","map","basemap","view","container","zoom","center","then","vsTemplate","val","field","contentTemplate","title","content","showVS","features","id","color","fillColor","outColor","outlineColor","Math","floor","$","find","css","background","toString","renderer","symbol","outline","width","visualVariables","sizeVisVar","vslyr","source","fields","objectIdField","geometryType","add","reorder","getZoneCount","Promise","resolve","reject","url","get","res","setVsAttr","rows","results","popTempt","wantedFeatures","forEach","feature","index","popupTemplate","_iteratorNormalCompletion4","_didIteratorError4","_iteratorError4","undefined","_step4","_iterator4","Symbol","iterator","next","done","row","value","zone","attributes","FID","count","push","err","searchForIt","addResult","desc","popid","attr","class","data-popid","append","text","click","featureId","this","data","console","log","authLyrCtrl","inviewIndex","flayr","authLyrs","query","where","returnGeometry","outFields","queryFeatures","popup","open","location","geometry","centroid","showProj","resultDiv","projects","hide","remove","zones","addClass","$input","show","length","_i","rs","key","substring","_i2","_key","links","csvNames","csvs","split","searchLayerControl","setVSField","hasClass","clear","VsCtrl","setUp","unbind","checkbox","change","contentTable","searchTemplate","compass","viewModel","startup","homeBtn","basemapToggle","nextBasemap","legend","ui","zoningLyr","zoningLyrCtrl","on","toggle","lyrIds","i","tempLyr","switchTo","type","valueUnit","stops","size","name","alias","concat","item","each","layerCount","lyrid","addVsLyr","baseLayer","vsLayers","inviewLyrs","addLyr","removeLyr","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_step","_iterator","addpLayer","opVisVar","pLayer","addzLayer","zLayer","projs","clearSR","pFeatures","zFeatures","_iteratorNormalCompletion2","_didIteratorError2","_iteratorError2","_step2","_iterator2","z","relevance","pCount","_iteratorNormalCompletion3","_didIteratorError3","_iteratorError3","_step3","_iterator3","p","opacity","onChecked","vss","parent","onUnchecked"],"mappings":"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","file":"core.babeled.min.js","sourcesContent":["\"use strict\";\n\nrequire([\"esri/Map\", \"esri/views/MapView\", \"esri/layers/FeatureLayer\", \"esri/PopupTemplate\", \"esri/widgets/Legend\", \"esri/widgets/Compass\", \"esri/widgets/Compass/CompassViewModel\", \"esri/widgets/Home\", \"esri/widgets/Home/HomeViewModel\", \"esri/widgets/BasemapToggle\", \"esri/widgets/Popup\", \"esri/tasks/QueryTask\", \"esri/tasks/support/Query\", \"esri/symbols/SimpleFillSymbol\", \"esri/symbols/SimpleMarkerSymbol\", \"esri/layers/GraphicsLayer\", \"esri/Graphic\", \"esri/geometry/Point\", \"esri/renderers/SimpleRenderer\", \"esri/renderers/ClassBreaksRenderer\", \"dojo/domReady!\"], function (Map, MapView, FeatureLayer, PopupTemplate, Legend, Compass, CompassVM, Home, HomeVM, BasemapToggle, Popup, QueryTask, Query, SimpleFillSymbol, SimpleMarkerSymbol, GraphicsLayer, Graphic, Point, SimpleRenderer, ClassBreaksRenderer) {\n\n    var map = new Map({\n        basemap: \"oceans\"\n    });\n    var view = new MapView({\n        container: \"map-container\",\n        map: map,\n        zoom: 9,\n        center: [121, 33]\n    });\n    var services = ['zoning', 'authorized', 'authorized_source', 'authorized_cata1', 'authorized_cata2', 'authorized_method'];\n    view.then(function () {\n\n        $('input[name=\"search\"').change(searchForIt);\n\n        $('i.icon.search').click(searchForIt);\n\n        var contentID = \"<label class='data-fid loader' data-fid='{FID}'>Loading...</label>\";\n        var contentTable = '<table class=\"ui celled table\"  data-fid=\"{FID}\">' + '<tbody>' + '<tr><td>区域ID</td><td>{FID}</td></tr>' + '<tr><td>配号来源</td><td>{配号来源}</td></tr>' + '<tr><td>用海一级类</td><td>{用海一级类}</td></tr>' + '<tr><td>用海二级类</td><td>{用海二级类}</td></tr>' + '<tr><td>用海方式</td><td>{用海方式}</td></tr>' + '<tr><td class=\"projects\">项目</td><td>{数量}<a href=\"#\" class=\"projects-link\" data-zone={FID} onclick=\"showProjects()\">点击查看项目详情</a></td></tr>' + '</tbody>' + '</table>';\n        var searchTemplate = '<table class=\"ui celled table\"  data-fid=\"{FID}\">' + '<tbody>' + '<tr><td class=\"projects\">搜索结果项目数量</td><td>{数量}<a href=\"#\" class=\"projects-link\" data-zone={FID} onclick=\"showProjects()\"> 点击查看项目详情</a></td></tr>' + '<tr><td class=\"projects\">项目平均相关程度</td><td>{相关程度}</td></tr>' + '<tr><td>区域ID</td><td>{FID}</td></tr>' + '<tr><td>配号来源</td><td>{配号来源}</td></tr>' + '<tr><td>用海一级类</td><td>{用海一级类}</td></tr>' + '<tr><td>用海二级类</td><td>{用海二级类}</td></tr>' + '<tr><td>用海方式</td><td>{用海方式}</td></tr>' + '</tbody>' + '</table>';\n\n        function vsTemplate(val, field) {\n            var contentTemplate = '<table class=\"ui celled table\"  data-fid=\"{FID}\">' + '<tbody>' + '<tr><td class=\"projects\">' + val + '项目数量</td><td>{数量}<a href=\"#\" class=\"projects-link\" data-zone={FID} data-field=' + field + ' data-val=' + val + ' onclick=\"showProjects()\"> 点击查看项目详情</a></td></tr>' + '<tr><td>配号来源</td><td>{配号来源}</td></tr>' + '<tr><td>用海一级类</td><td>{用海一级类}</td></tr>' + '<tr><td>用海二级类</td><td>{用海二级类}</td></tr>' + '<tr><td>用海方式</td><td>{用海方式}</td></tr>' + '</tbody>' + '</table>';\n            return new PopupTemplate({\n                title: '区域ID: {FID}',\n                content: contentTemplate\n            });\n        }\n        //==widgets======================//\n\n        var compass = new Compass({\n            viewModel: new CompassVM({\n                view: view\n            })\n        }, \"compass\");\n        compass.startup();\n\n        var homeBtn = new Home({\n            viewModel: new HomeVM({\n                view: view\n            })\n        }, \"home\");\n        homeBtn.startup();\n\n        var basemapToggle = new BasemapToggle({\n            view: view,\n            nextBasemap: \"hybrid\"\n        }, 'basemap');\n        basemapToggle.startup();\n\n        //var legend = new Legend({ view: view }, 'legend');\n\n        var legend = new Legend({\n            view: view\n        });\n        legend.startup();\n\n        view.ui.add(legend, \"bottom-right\");\n\n        //==widgets======================//\n\n        var zoningLyr = new FeatureLayer({\n            id: 'base',\n            url: \"http://localhost:6080/arcgis/rest/services/区域/MapServer/0\"\n        });\n\n        map.add(zoningLyr);\n        map.reorder(zoningLyr, 0);\n\n        var zoningLyrCtrl = {\n            on: true,\n            toggle: function toggle() {\n                if (this.on) {\n                    map.remove(zoningLyr);\n                } else {\n                    map.add(zoningLyr);\n                    map.reorder(zoningLyr, 0);\n                };\n                this.on = !this.on;\n            }\n        };\n\n        var lyrIds = ['功能区划', '确权数据', '确权数据--配号来源', '确权数据--用海一级类', '确权数据--用海二级类', '确权数据--用海方式'];\n\n        var authLyrs = [];\n\n        for (var i = 1; i < 6; i++) {\n            var tempLyr = new FeatureLayer({\n                id: lyrIds[i],\n                outFields: [\"*\"],\n                url: \"http://localhost:6080/arcgis/rest/services/用海信息/MapServer/\" + i,\n                popupTemplate: new PopupTemplate({\n                    title: '区域ID: {FID}',\n                    content: contentTable\n                })\n            });\n\n            if (i == 1) map.add(tempLyr);\n\n            authLyrs[i] = tempLyr;\n        }\n\n        var authLyrCtrl = {\n            inviewIndex: 1,\n            on: true,\n            switchTo: function switchTo(val) {\n                if (val !== this.inviewIndex) {\n                    map.remove(authLyrs[this.inviewIndex]);\n                    map.add(authLyrs[val]);\n                    map.reorder(authLyrs[val], 1);\n                    this.inviewIndex = val;\n                }\n            },\n            toggle: function toggle() {\n                if (this.on) {\n                    map.remove(authLyrs[this.inviewIndex]);\n                    this.on = false;\n                } else {\n                    map.add(authLyrs[this.inviewIndex]);\n                    map.reorder(authLyrs[this.inviewIndex], 1);\n                    this.on = true;\n                }\n            }\n        };\n        var fillColor = [[26, 59, 180, 0.7], [155, 45, 95, 0.7], [26, 119, 80, 0.7], [126, 119, 80, 0.7], [176, 189, 140, 0.7], [49, 145, 85, 0.7], [26, 119, 180, 0.7]];\n        var outlineColor = [[255, 255, 255, 0.6], [26, 59, 180, 0.6], [155, 45, 95, 0.6], [26, 119, 80, 0.6], [126, 119, 80, 0.6], [26, 119, 180, 0.6]];\n        var sizeVisVar = {\n            type: \"size\",\n            field: \"数量\",\n            valueUnit: \"unknown\",\n            stops: [{\n                value: 1,\n                size: 8\n            }, {\n                value: 2,\n                size: 24\n            }, {\n                value: 3,\n                size: 36\n            }, {\n                value: 4,\n                size: 42\n            }]\n        };\n\n        var fields = [{\n            name: \"ObjectID\",\n            alias: \"ObjectID\",\n            type: \"oid\"\n        }, {\n            name: \"数量\",\n            alias: \"数量\",\n            type: \"double\"\n        }, {\n            name: \"相关程度\",\n            alias: \"相关程度\",\n            type: \"number\"\n        }].concat(authLyrs[1].fields);;\n\n        function showVS(features, val, field, id) {\n\n            var title = field + ': ' + val + '项目';\n            var color = fillColor[(id - 1) % 7];\n            var outColor = outlineColor[Math.floor((id - 1) / 7)];\n            $('.checkbox[data-field=\"' + field + '\"][data-val=\"' + val + '\"]').find('.symbol').css({\n                \"background\": \"rgba(\" + color.toString() + \")\"\n            });\n            var renderer = new SimpleRenderer({\n                symbol: new SimpleMarkerSymbol({\n                    color: color,\n                    outline: {\n                        color: outColor,\n                        width: 2\n                    }\n                }),\n                visualVariables: [sizeVisVar]\n            });\n\n            var vslyr = new FeatureLayer({\n                id: id,\n                title: title,\n                source: features,\n                fields: fields,\n                objectIdField: \"ObjectID\",\n                renderer: renderer,\n                geometryType: \"polygon\"\n\n            });\n\n            map.add(vslyr);\n\n            map.reorder(vslyr, 99);\n            return vslyr;\n        }\n\n        var VsCtrl = function () {\n            var vsLayers = {};\n            var baseLayer = authLyrs[1];\n            var inviewLyrs = [];\n            var vsVisible = true;\n            var layerCount = 0;\n\n            function setUp(item) {\n                if (zoningLyrCtrl.on) $('input.toggle.toggle-zoning').click();\n                if (authLyrCtrl.on) $('input.toggle.toggle-auth').click();\n                var field = item.data('type');\n                var content = item.next('.content');\n                var values = [];\n                content.find('.vs-selection input[type=\"checkbox\"]').each(function () {\n                    if ($(this).val() !== '全部') {\n                        layerCount++;\n                        var lyrid = layerCount;\n                        addVsLyr($(this).val(), field, lyrid);\n                        $(this).attr(\"data-id\", lyrid);\n                    }\n                });\n            }\n\n            function addVsLyr(val, field, lyrid) {\n                var popTempt = vsTemplate(val, field);\n                getZoneCount(val, field).then(function (rows) {\n\n                    baseLayer.queryFeatures().then(function (results) {\n                        vsLayers[lyrid] = showVS(setVsAttr(rows, results, popTempt), val, field, lyrid);\n                        inviewLyrs.push(lyrid);\n                    });\n                });\n            }\n\n            function addLyr(key) {\n                for (var id in vsLayers) {\n                    if (id == key) {\n                        map.add(vsLayers[id]);\n                    }\n                }\n            }\n\n            function removeLyr(key) {\n                var _iteratorNormalCompletion = true;\n                var _didIteratorError = false;\n                var _iteratorError = undefined;\n\n                try {\n                    for (var _iterator = inviewLyrs[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {\n                        var id = _step.value;\n\n                        if (id == key) {\n                            map.remove(vsLayers[id]);\n                        }\n                    }\n                } catch (err) {\n                    _didIteratorError = true;\n                    _iteratorError = err;\n                } finally {\n                    try {\n                        if (!_iteratorNormalCompletion && _iterator.return) {\n                            _iterator.return();\n                        }\n                    } finally {\n                        if (_didIteratorError) {\n                            throw _iteratorError;\n                        }\n                    }\n                }\n            }\n            return {\n                setUp: setUp,\n                addVsLyr: addVsLyr,\n                addLyr: addLyr,\n                removeLyr: removeLyr\n            };\n        }();\n\n        var searchLayerControl = function () {\n            var pLayer = {};\n            var zLayer = {};\n            var opVisVar = {\n                type: \"opacity\",\n                field: \"相关程度\",\n                valueUnit: \"unknown\",\n                stops: [{\n                    value: 1e-10,\n                    opacity: 0.01\n                }, {\n                    value: 1e-7,\n                    opacity: 0.05\n                }, {\n                    value: 2e-7,\n                    opacity: 0.1\n                }, {\n                    value: 3e-7,\n                    opacity: 0.2\n                }, {\n                    value: 3e-6,\n                    opacity: 0.4\n                }, {\n                    value: 1e-3,\n                    opacity: 0.5\n                }, {\n                    value: 1e-2,\n                    opacity: 0.7\n                }, {\n                    value: 1e-1,\n                    opacity: 0.8\n                }, {\n                    value: 1,\n                    opacity: 1\n                }]\n            };\n\n            function addpLayer(features) {\n                var title = '用海项目搜索结果';\n                var color = fillColor[5];\n                var outColor = outlineColor[0];\n                var renderer = new SimpleRenderer({\n                    symbol: new SimpleMarkerSymbol({\n                        color: color,\n                        outline: {\n                            color: outColor,\n                            width: 2\n                        }\n                    }),\n                    visualVariables: [sizeVisVar, opVisVar]\n                });\n\n                pLayer = new FeatureLayer({\n                    title: title,\n                    source: features,\n                    fields: fields,\n                    objectIdField: \"ObjectID\",\n                    renderer: renderer,\n                    geometryType: \"polygon\"\n                });\n\n                map.add(pLayer);\n                map.reorder(pLayer, 99);\n            }\n\n            function addzLayer(features) {\n                var title = '确权区域搜索结果';\n\n                zLayer = new FeatureLayer({\n                    title: title,\n                    source: features,\n                    fields: fields,\n                    objectIdField: \"ObjectID\",\n                    geometryType: \"polygon\"\n                });\n\n                map.add(zLayer);\n                map.reorder(zLayer, 1);\n            }\n\n            function show(projs, zones) {\n                clearSR();\n                $('.vs-selection .checkbox.allin').checkbox('uncheck');\n\n                if (zoningLyrCtrl.on) $('input.toggle.toggle-zoning').click();\n\n                if (authLyrCtrl.on) $('input.toggle.toggle-auth').click();\n                authLyrs[1].queryFeatures().then(function (results) {\n                    var features = results.features;\n                    var pFeatures = [];\n                    var zFeatures = [];\n                    features.forEach(function (feature, index) {\n                        var _iteratorNormalCompletion2 = true;\n                        var _didIteratorError2 = false;\n                        var _iteratorError2 = undefined;\n\n                        try {\n\n                            for (var _iterator2 = zones[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {\n                                var z = _step2.value;\n\n                                if (z.id == feature.attributes.FID) {\n                                    zFeatures.push(feature);\n                                }\n                            }\n                        } catch (err) {\n                            _didIteratorError2 = true;\n                            _iteratorError2 = err;\n                        } finally {\n                            try {\n                                if (!_iteratorNormalCompletion2 && _iterator2.return) {\n                                    _iterator2.return();\n                                }\n                            } finally {\n                                if (_didIteratorError2) {\n                                    throw _iteratorError2;\n                                }\n                            }\n                        }\n\n                        var relevance = 0;\n                        var pCount = 0;\n                        var _iteratorNormalCompletion3 = true;\n                        var _didIteratorError3 = false;\n                        var _iteratorError3 = undefined;\n\n                        try {\n                            for (var _iterator3 = projs[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {\n                                var p = _step3.value;\n\n                                if (p['确权区域ID'] == feature.attributes.FID) {\n                                    relevance += p.relevance;\n                                    pCount++;\n                                }\n                            }\n                        } catch (err) {\n                            _didIteratorError3 = true;\n                            _iteratorError3 = err;\n                        } finally {\n                            try {\n                                if (!_iteratorNormalCompletion3 && _iterator3.return) {\n                                    _iterator3.return();\n                                }\n                            } finally {\n                                if (_didIteratorError3) {\n                                    throw _iteratorError3;\n                                }\n                            }\n                        }\n\n                        if (pCount) {\n                            feature.attributes['数量'] = pCount;\n                            feature.attributes['相关程度'] = relevance / pCount;\n                            feature.popupTemplate.content = searchTemplate;\n                            pFeatures.push(feature);\n                        }\n                    });\n                    addzLayer(zFeatures);\n                    addpLayer(pFeatures);\n                });\n            }\n\n            function clearSR() {\n                map.remove(pLayer);\n                map.remove(zLayer);\n                pLayer = {};\n                zLayer = {};\n            }\n            return {\n                show: show,\n                clear: clearSR\n            };\n        }();\n\n        function getZoneCount(val, field) {\n            return new Promise(function (resolve, reject) {\n                var url = '/mysql/zone_count?field=' + field + '&val=' + val;\n                $.get(url, function (res) {\n                    resolve(res);\n                });\n            });\n        }\n\n        function setVsAttr(rows, results, popTempt) {\n            var features = results.features;\n            var wantedFeatures = [];\n            features.forEach(function (feature, index) {\n                feature.popupTemplate = popTempt;\n                var _iteratorNormalCompletion4 = true;\n                var _didIteratorError4 = false;\n                var _iteratorError4 = undefined;\n\n                try {\n                    for (var _iterator4 = rows[Symbol.iterator](), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {\n                        var row = _step4.value;\n\n                        if (row.zone == feature.attributes.FID) {\n                            feature.attributes['数量'] = row.count;\n                            wantedFeatures.push(feature);\n                        }\n                    }\n                } catch (err) {\n                    _didIteratorError4 = true;\n                    _iteratorError4 = err;\n                } finally {\n                    try {\n                        if (!_iteratorNormalCompletion4 && _iterator4.return) {\n                            _iterator4.return();\n                        }\n                    } finally {\n                        if (_didIteratorError4) {\n                            throw _iteratorError4;\n                        }\n                    }\n                }\n            });\n            return wantedFeatures;\n        }\n\n        function searchForIt() {\n            var resultDiv = $('#searchResult.results');\n            var projects = resultDiv.find('.projects');\n            projects.hide();\n            projects.find('.result').remove();\n            var zones = resultDiv.find('.zones');\n            zones.hide();\n            zones.find('.result').remove();\n            resultDiv.append('<div class=\"ui segment\"><div class=\"ui active inverted dimmer\"><div class=\"ui loader\"></div></div><p></p></div>');\n            resultDiv.addClass('visible');\n            var $input = $('input[name=\"search\"');\n            $('i.icon.remove').show();\n            $('i.icon.search').hide();\n            $.get('/mysql/search?q=' + $input.val(), function (res) {\n                resultDiv.find('.segment').remove();\n                console.log(res.rows[0].length);\n\n                console.log(res.rows[1].length);\n                for (var _i in res.rows[0]) {\n                    if (_i < 5) {\n                        var rs = res.rows[0][_i];\n                        projects.show();\n                        $('a.csv1').show();\n                        var desc = '';\n                        for (var key in rs) {\n                            desc = desc + key + ': ' + rs[key] + ', ';\n                        }\n                        desc = desc.substring(0, 54) + '...';\n                        projects.append(addResult(rs['项目名称'], desc, rs['确权区域ID']));\n                    }\n                }\n\n                for (var _i2 in res.rows[1]) {\n                    if (_i2 < 5) {\n                        var rs = res.rows[1][_i2];\n                        zones.show();\n                        $('a.csv2').show();\n                        var desc = '';\n                        for (var _key in rs) {\n                            if (_key == 'init_date') {\n                                rs[_key] = rs[_key].substring(0, 10);\n                            }\n                            desc = desc + _key + ': ' + rs[_key] + ', ';\n                        }\n                        desc = desc.substring(0, 48) + '...';\n                        zones.append(addResult(rs.id, desc, rs.id));\n                    }\n                }\n                var links = resultDiv.find(\".download-results\");\n                var csvNames = res.csvs.split(',');\n\n                links.find('.csv1').attr('href', '/mysql/csv/' + csvNames[0]);\n                links.find('.csv2').attr('href', '/mysql/csv/' + csvNames[1]);\n                links.show();\n                searchLayerControl.show(res.rows[0], res.rows[1]);\n            });\n\n            function addResult(title, desc, popid) {\n                return $('<a>').attr({ 'class': 'result', 'data-popid': popid }).append($('<div>').attr('class', 'content').append($('<div>').attr('class', 'title').text(title)).append($('<div>').attr('class', 'description').text(desc))).click(function () {\n                    var featureId = $(this).data('popid');\n                    console.log(authLyrCtrl.inviewIndex);\n                    var flayr = authLyrs[authLyrCtrl.inviewIndex];\n                    var query = new Query();\n                    query.where = \"FID = \" + featureId;\n                    query.returnGeometry = true;\n                    query.outFields = ['*'];\n                    map.reorder(flayr, 100);\n                    flayr.queryFeatures(query).then(function (results) {\n                        console.log(results);\n                        view.popup.open({\n                            features: results.features,\n                            location: results.features[0].geometry.centroid\n                        });\n                    });\n                    showProj(popid);\n                });\n            }\n        }\n\n        $('input.toggle.toggle-zoning').change(function () {\n            zoningLyrCtrl.toggle();\n        });\n\n        $('input.toggle.toggle-auth').change(function () {\n            authLyrCtrl.toggle();\n        });\n\n        $('select[name=authLyr]').change(function () {\n            authLyrCtrl.switchTo($(this).val());\n        });\n\n        $('#searchDiv i.icon.remove').click(searchLayerControl.clear);\n\n        $('.title.item.statistic.proj').click(setVSField);\n\n        function setVSField() {\n            if ($(this).hasClass('active')) {\n                clear();\n            } else {\n                VsCtrl.setUp($(this));\n                $(this).unbind('click', setVSField);\n                $(this).find('.checkbox.allin').checkbox('check');\n            }\n        }\n\n        $('.vs-selection .checkbox.allin').checkbox().checkbox({\n            onChecked: function onChecked() {\n                var vss = $(this).parent('.checkbox').parent('.vs-selection');\n                vss.find('.checkbox:not(.allin)').checkbox('check');\n            },\n            onUnchecked: function onUnchecked() {\n                var vss = $(this).parent('.checkbox').parent('.vs-selection');\n                vss.find('.checkbox:not(.allin)').checkbox('uncheck');\n            }\n        }).checkbox('check');\n\n        $('.vs-selection .checkbox:not(.allin)').checkbox().checkbox({\n            onChecked: function onChecked() {\n                VsCtrl.addLyr($(this).data('id'));\n            },\n            onUnchecked: function onUnchecked() {\n                VsCtrl.removeLyr($(this).data('id'));\n            }\n        }).checkbox('check');\n    });\n\n    function showCoordinates(evt) {\n        $('#esri_widgets_Attribution_0 > div.esri-attribution__sources').html(evt.mapPoint.latitude + evt.mapPoint.longitude);\n    }\n});","require([\r\n    \"esri/Map\",\r\n    \"esri/views/MapView\",\r\n    \"esri/layers/FeatureLayer\",\r\n    \"esri/PopupTemplate\",\r\n    \"esri/widgets/Legend\",\r\n    \"esri/widgets/Compass\",\r\n    \"esri/widgets/Compass/CompassViewModel\",\r\n    \"esri/widgets/Home\",\r\n    \"esri/widgets/Home/HomeViewModel\",\r\n    \"esri/widgets/BasemapToggle\",\r\n    \"esri/widgets/Popup\",\r\n    \"esri/tasks/QueryTask\",\r\n    \"esri/tasks/support/Query\",\r\n    \"esri/symbols/SimpleFillSymbol\",\r\n    \"esri/symbols/SimpleMarkerSymbol\",\r\n    \"esri/layers/GraphicsLayer\",\r\n    \"esri/Graphic\",\r\n    \"esri/geometry/Point\",\r\n    \"esri/renderers/SimpleRenderer\",\r\n    \"esri/renderers/ClassBreaksRenderer\",\r\n    \"dojo/domReady!\"\r\n], function(Map, MapView, FeatureLayer, PopupTemplate, Legend, Compass, CompassVM, Home, HomeVM, BasemapToggle, Popup, QueryTask, Query, SimpleFillSymbol, SimpleMarkerSymbol, GraphicsLayer, Graphic, Point, SimpleRenderer, ClassBreaksRenderer) {\r\n\r\n    var map = new Map({\r\n        basemap: \"oceans\"\r\n    });\r\n    var view = new MapView({\r\n        container: \"map-container\",\r\n        map: map,\r\n        zoom: 9,\r\n        center: [121, 33]\r\n    });\r\n    var services = ['zoning', 'authorized', 'authorized_source', 'authorized_cata1', 'authorized_cata2', 'authorized_method'];\r\n    view.then(function() {\r\n\r\n        $('input[name=\"search\"').change(searchForIt);\r\n\r\n\r\n        $('i.icon.search').click(searchForIt);\r\n\r\n        var contentID = \"<label class='data-fid loader' data-fid='{FID}'>Loading...</label>\";\r\n        var contentTable = '<table class=\"ui celled table\"  data-fid=\"{FID}\">' +\r\n            '<tbody>' +\r\n            '<tr><td>区域ID</td><td>{FID}</td></tr>' +\r\n            '<tr><td>配号来源</td><td>{配号来源}</td></tr>' +\r\n            '<tr><td>用海一级类</td><td>{用海一级类}</td></tr>' +\r\n            '<tr><td>用海二级类</td><td>{用海二级类}</td></tr>' +\r\n            '<tr><td>用海方式</td><td>{用海方式}</td></tr>' +\r\n            '<tr><td class=\"projects\">项目</td><td>{数量}<a href=\"#\" class=\"projects-link\" data-zone={FID} onclick=\"showProjects()\">点击查看项目详情</a></td></tr>' +\r\n            '</tbody>' +\r\n            '</table>';\r\n        var searchTemplate = '<table class=\"ui celled table\"  data-fid=\"{FID}\">' +\r\n            '<tbody>' +\r\n            '<tr><td class=\"projects\">搜索结果项目数量</td><td>{数量}<a href=\"#\" class=\"projects-link\" data-zone={FID} onclick=\"showProjects()\"> 点击查看项目详情</a></td></tr>' +\r\n            '<tr><td class=\"projects\">项目平均相关程度</td><td>{相关程度}</td></tr>' +\r\n            '<tr><td>区域ID</td><td>{FID}</td></tr>' +\r\n            '<tr><td>配号来源</td><td>{配号来源}</td></tr>' +\r\n            '<tr><td>用海一级类</td><td>{用海一级类}</td></tr>' +\r\n            '<tr><td>用海二级类</td><td>{用海二级类}</td></tr>' +\r\n            '<tr><td>用海方式</td><td>{用海方式}</td></tr>' +\r\n            '</tbody>' +\r\n            '</table>';\r\n\r\n        function vsTemplate(val, field) {\r\n            var contentTemplate = '<table class=\"ui celled table\"  data-fid=\"{FID}\">' +\r\n                '<tbody>' +\r\n                '<tr><td class=\"projects\">' + val + '项目数量</td><td>{数量}<a href=\"#\" class=\"projects-link\" data-zone={FID} data-field=' + field + ' data-val=' + val + ' onclick=\"showProjects()\"> 点击查看项目详情</a></td></tr>' +\r\n                '<tr><td>配号来源</td><td>{配号来源}</td></tr>' +\r\n                '<tr><td>用海一级类</td><td>{用海一级类}</td></tr>' +\r\n                '<tr><td>用海二级类</td><td>{用海二级类}</td></tr>' +\r\n                '<tr><td>用海方式</td><td>{用海方式}</td></tr>' +\r\n                '</tbody>' +\r\n                '</table>';\r\n            return new PopupTemplate({\r\n                title: '区域ID: {FID}',\r\n                content: contentTemplate\r\n            })\r\n        }\r\n        //==widgets======================//\r\n\r\n        var compass = new Compass({\r\n            viewModel: new CompassVM({\r\n                view: view\r\n            })\r\n        }, \"compass\");\r\n        compass.startup();\r\n\r\n        var homeBtn = new Home({\r\n            viewModel: new HomeVM({\r\n                view: view\r\n            })\r\n        }, \"home\");\r\n        homeBtn.startup();\r\n\r\n        var basemapToggle = new BasemapToggle({\r\n            view: view,\r\n            nextBasemap: \"hybrid\"\r\n        }, 'basemap');\r\n        basemapToggle.startup();\r\n\r\n        //var legend = new Legend({ view: view }, 'legend');\r\n\r\n        var legend = new Legend({\r\n            view: view\r\n        });\r\n        legend.startup();\r\n\r\n        view.ui.add(legend, \"bottom-right\");\r\n\r\n        //==widgets======================//\r\n\r\n\r\n        var zoningLyr = new FeatureLayer({\r\n            id: 'base',\r\n            url: \"http://localhost:6080/arcgis/rest/services/区域/MapServer/0\",\r\n        });\r\n\r\n        map.add(zoningLyr);\r\n        map.reorder(zoningLyr, 0);\r\n\r\n        var zoningLyrCtrl = {\r\n            on: true,\r\n            toggle: function() {\r\n                if (this.on) {\r\n                    map.remove(zoningLyr);\r\n                } else {\r\n                    map.add(zoningLyr);\r\n                    map.reorder(zoningLyr, 0);\r\n                };\r\n                this.on = !this.on;\r\n            }\r\n        };\r\n\r\n        var lyrIds = ['功能区划', '确权数据', '确权数据--配号来源', '确权数据--用海一级类', '确权数据--用海二级类', '确权数据--用海方式'];\r\n\r\n        var authLyrs = [];\r\n\r\n        for (var i = 1; i < 6; i++) {\r\n            var tempLyr = new FeatureLayer({\r\n                id: lyrIds[i],\r\n                outFields: [\"*\"],\r\n                url: \"http://localhost:6080/arcgis/rest/services/用海信息/MapServer/\" + i,\r\n                popupTemplate: new PopupTemplate({\r\n                    title: '区域ID: {FID}',\r\n                    content: contentTable\r\n                })\r\n            });\r\n\r\n            if (i == 1) map.add(tempLyr);\r\n\r\n            authLyrs[i] = tempLyr;\r\n        }\r\n\r\n        var authLyrCtrl = {\r\n            inviewIndex: 1,\r\n            on: true,\r\n            switchTo: function(val) {\r\n                if (val !== this.inviewIndex) {\r\n                    map.remove(authLyrs[this.inviewIndex]);\r\n                    map.add(authLyrs[val]);\r\n                    map.reorder(authLyrs[val], 1);\r\n                    this.inviewIndex = val;\r\n                }\r\n            },\r\n            toggle: function() {\r\n                if (this.on) {\r\n                    map.remove(authLyrs[this.inviewIndex]);\r\n                    this.on = false;\r\n                } else {\r\n                    map.add(authLyrs[this.inviewIndex]);\r\n                    map.reorder(authLyrs[this.inviewIndex], 1);\r\n                    this.on = true;\r\n                }\r\n            }\r\n        };\r\n        var fillColor = [\r\n            [26, 59, 180, 0.7],\r\n            [155, 45, 95, 0.7],\r\n            [26, 119, 80, 0.7],\r\n            [126, 119, 80, 0.7],\r\n            [176, 189, 140, 0.7],\r\n            [49, 145, 85, 0.7],\r\n            [26, 119, 180, 0.7]\r\n        ];\r\n        var outlineColor = [\r\n            [255, 255, 255, 0.6],\r\n            [26, 59, 180, 0.6],\r\n            [155, 45, 95, 0.6],\r\n            [26, 119, 80, 0.6],\r\n            [126, 119, 80, 0.6],\r\n            [26, 119, 180, 0.6]\r\n        ];\r\n        var sizeVisVar = {\r\n            type: \"size\",\r\n            field: \"数量\",\r\n            valueUnit: \"unknown\",\r\n            stops: [{\r\n                value: 1,\r\n                size: 8\r\n            }, {\r\n                value: 2,\r\n                size: 24\r\n            }, {\r\n                value: 3,\r\n                size: 36\r\n            }, {\r\n                value: 4,\r\n                size: 42\r\n            }]\r\n        };\r\n\r\n        var fields = [{\r\n            name: \"ObjectID\",\r\n            alias: \"ObjectID\",\r\n            type: \"oid\"\r\n        }, {\r\n            name: \"数量\",\r\n            alias: \"数量\",\r\n            type: \"double\"\r\n        }, {\r\n            name: \"相关程度\",\r\n            alias: \"相关程度\",\r\n            type: \"number\"\r\n        }].concat(authLyrs[1].fields);;\r\n\r\n        function showVS(features, val, field, id) {\r\n\r\n            var title = field + ': ' + val + '项目';\r\n            var color = fillColor[((id - 1) % 7)];\r\n            var outColor = outlineColor[Math.floor((id - 1) / 7)];\r\n            $('.checkbox[data-field=\"' + field + '\"][data-val=\"' + val + '\"]').find('.symbol').css({\r\n                \"background\": \"rgba(\" + color.toString() + \")\"\r\n            });\r\n            var renderer = new SimpleRenderer({\r\n                symbol: new SimpleMarkerSymbol({\r\n                    color: color,\r\n                    outline: {\r\n                        color: outColor,\r\n                        width: 2\r\n                    }\r\n                }),\r\n                visualVariables: [sizeVisVar]\r\n            });\r\n\r\n\r\n            var vslyr = new FeatureLayer({\r\n                id: id,\r\n                title: title,\r\n                source: features,\r\n                fields: fields,\r\n                objectIdField: \"ObjectID\",\r\n                renderer: renderer,\r\n                geometryType: \"polygon\"\r\n\r\n            });\r\n\r\n            map.add(vslyr);\r\n\r\n            map.reorder(vslyr, 99);\r\n            return vslyr;\r\n        }\r\n\r\n\r\n        var VsCtrl = function() {\r\n            var vsLayers = {};\r\n            var baseLayer = authLyrs[1];\r\n            var inviewLyrs = [];\r\n            var vsVisible = true;\r\n            var layerCount = 0;\r\n\r\n            function setUp(item) {\r\n                if (zoningLyrCtrl.on) $('input.toggle.toggle-zoning').click();\r\n                if (authLyrCtrl.on) $('input.toggle.toggle-auth').click();\r\n                var field = item.data('type');\r\n                var content = item.next('.content');\r\n                var values = [];\r\n                content.find('.vs-selection input[type=\"checkbox\"]').each(function() {\r\n                    if ($(this).val() !== '全部') {\r\n                        layerCount++;\r\n                        var lyrid = layerCount;\r\n                        addVsLyr($(this).val(), field, lyrid);\r\n                        $(this).attr(\"data-id\", lyrid);\r\n                    }\r\n                });\r\n            }\r\n\r\n            function addVsLyr(val, field, lyrid) {\r\n                var popTempt = vsTemplate(val, field);\r\n                getZoneCount(val, field).then(function(rows) {\r\n\r\n                    baseLayer.queryFeatures().then(function(results) {\r\n                        vsLayers[lyrid] = showVS(setVsAttr(rows, results, popTempt), val, field, lyrid);\r\n                        inviewLyrs.push(lyrid);\r\n                    });\r\n                });\r\n            }\r\n\r\n            function addLyr(key) {\r\n                for (let id in vsLayers) {\r\n                    if (id == key) {\r\n                        map.add(vsLayers[id]);\r\n                    }\r\n                }\r\n            }\r\n\r\n            function removeLyr(key) {\r\n                for (let id of inviewLyrs) {\r\n                    if (id == key) {\r\n                        map.remove(vsLayers[id]);\r\n                    }\r\n                }\r\n            }\r\n            return {\r\n                setUp: setUp,\r\n                addVsLyr: addVsLyr,\r\n                addLyr: addLyr,\r\n                removeLyr: removeLyr\r\n            }\r\n        }();\r\n\r\n        var searchLayerControl = function() {\r\n            var pLayer = {};\r\n            var zLayer = {};\r\n            var opVisVar = {\r\n                type: \"opacity\",\r\n                field: \"相关程度\",\r\n                valueUnit: \"unknown\",\r\n                stops: [{\r\n                    value: 1e-10,\r\n                    opacity: 0.01\r\n                }, {\r\n                    value: 1e-7,\r\n                    opacity: 0.05\r\n                }, {\r\n                    value: 2e-7,\r\n                    opacity: 0.1\r\n                }, {\r\n                    value: 3e-7,\r\n                    opacity: 0.2\r\n                }, {\r\n                    value: 3e-6,\r\n                    opacity: 0.4\r\n                }, {\r\n                    value: 1e-3,\r\n                    opacity: 0.5\r\n                }, {\r\n                    value: 1e-2,\r\n                    opacity: 0.7\r\n                }, {\r\n                    value: 1e-1,\r\n                    opacity: 0.8\r\n                }, {\r\n                    value: 1,\r\n                    opacity: 1\r\n                }]\r\n            };\r\n\r\n            function addpLayer(features) {\r\n                var title = '用海项目搜索结果';\r\n                var color = fillColor[5];\r\n                var outColor = outlineColor[0];\r\n                var renderer = new SimpleRenderer({\r\n                    symbol: new SimpleMarkerSymbol({\r\n                        color: color,\r\n                        outline: {\r\n                            color: outColor,\r\n                            width: 2\r\n                        }\r\n                    }),\r\n                    visualVariables: [sizeVisVar, opVisVar]\r\n                });\r\n\r\n\r\n                pLayer = new FeatureLayer({\r\n                    title: title,\r\n                    source: features,\r\n                    fields: fields,\r\n                    objectIdField: \"ObjectID\",\r\n                    renderer: renderer,\r\n                    geometryType: \"polygon\"\r\n                });\r\n\r\n                map.add(pLayer);\r\n                map.reorder(pLayer, 99);\r\n            }\r\n\r\n            function addzLayer(features) {\r\n                var title = '确权区域搜索结果';\r\n\r\n                zLayer = new FeatureLayer({\r\n                    title: title,\r\n                    source: features,\r\n                    fields: fields,\r\n                    objectIdField: \"ObjectID\",\r\n                    geometryType: \"polygon\"\r\n                });\r\n\r\n                map.add(zLayer);\r\n                map.reorder(zLayer, 1);\r\n            }\r\n\r\n            function show(projs, zones) {\r\n                clearSR();\r\n                $('.vs-selection .checkbox.allin').checkbox('uncheck');\r\n\r\n                if (zoningLyrCtrl.on) $('input.toggle.toggle-zoning').click();\r\n\r\n                if (authLyrCtrl.on) $('input.toggle.toggle-auth').click();\r\n                authLyrs[1].queryFeatures().then(function(results) {\r\n                    var features = results.features;\r\n                    var pFeatures = [];\r\n                    var zFeatures = [];\r\n                    features.forEach(function(feature, index) {\r\n\r\n                        for (let z of zones) {\r\n                            if (z.id == feature.attributes.FID) {\r\n                                zFeatures.push(feature);\r\n                            }\r\n                        }\r\n                        var relevance = 0;\r\n                        var pCount = 0\r\n                        for (let p of projs) {\r\n                            if (p['确权区域ID'] == feature.attributes.FID) {\r\n                                relevance += p.relevance;\r\n                                pCount++;\r\n                            }\r\n                        }\r\n                        if (pCount) {\r\n                            feature.attributes['数量'] = pCount;\r\n                            feature.attributes['相关程度'] = relevance / pCount;\r\n                            feature.popupTemplate.content = searchTemplate;\r\n                            pFeatures.push(feature);\r\n                        }\r\n                    });\r\n                    addzLayer(zFeatures);\r\n                    addpLayer(pFeatures);\r\n\r\n                });\r\n            }\r\n\r\n            function clearSR() {\r\n                map.remove(pLayer);\r\n                map.remove(zLayer);\r\n                pLayer = {};\r\n                zLayer = {};\r\n            }\r\n            return {\r\n                show: show,\r\n                clear: clearSR\r\n            }\r\n        }();\r\n\r\n        function getZoneCount(val, field) {\r\n            return new Promise(function(resolve, reject) {\r\n                var url = '/mysql/zone_count?field=' + field + '&val=' + val;\r\n                $.get(url, function(res) {\r\n                    resolve(res);\r\n                })\r\n            })\r\n        }\r\n\r\n        function setVsAttr(rows, results, popTempt) {\r\n            var features = results.features;\r\n            var wantedFeatures = [];\r\n            features.forEach(function(feature, index) {\r\n                feature.popupTemplate = popTempt;\r\n                for (let row of rows) {\r\n                    if (row.zone == feature.attributes.FID) {\r\n                        feature.attributes['数量'] = row.count;\r\n                        wantedFeatures.push(feature);\r\n                    }\r\n                }\r\n            });\r\n            return wantedFeatures;\r\n        }\r\n\r\n        function searchForIt() {\r\n            var resultDiv = $('#searchResult.results');\r\n            var projects = resultDiv.find('.projects');\r\n            projects.hide();\r\n            projects.find('.result').remove();\r\n            var zones = resultDiv.find('.zones');\r\n            zones.hide();\r\n            zones.find('.result').remove();\r\n            resultDiv.append('<div class=\"ui segment\"><div class=\"ui active inverted dimmer\"><div class=\"ui loader\"></div></div><p></p></div>');\r\n            resultDiv.addClass('visible');\r\n            var $input = $('input[name=\"search\"');\r\n            $('i.icon.remove').show();\r\n            $('i.icon.search').hide();\r\n            $.get('/mysql/search?q=' + $input.val(), function(res) {\r\n                resultDiv.find('.segment').remove();\r\n                console.log(res.rows[0].length);\r\n\r\n                console.log(res.rows[1].length);\r\n                for (let i in res.rows[0]) {\r\n                    if (i < 5) {\r\n                        var rs = res.rows[0][i];\r\n                        projects.show();\r\n                        $('a.csv1').show();\r\n                        var desc = '';\r\n                        for (let key in rs) {\r\n                            desc = desc + key + ': ' + rs[key] + ', ';\r\n                        }\r\n                        desc = desc.substring(0, 54) + '...';\r\n                        projects.append(addResult(rs['项目名称'], desc, rs['确权区域ID']))\r\n                    }\r\n                }\r\n\r\n                for (let i in res.rows[1]) {\r\n                    if (i < 5) {\r\n                        var rs = res.rows[1][i];\r\n                        zones.show();\r\n                        $('a.csv2').show();\r\n                        var desc = '';\r\n                        for (let key in rs) {\r\n                            if (key == 'init_date') {\r\n                                rs[key] = rs[key].substring(0, 10);\r\n                            }\r\n                            desc = desc + key + ': ' + rs[key] + ', ';\r\n                        }\r\n                        desc = desc.substring(0, 48) + '...';\r\n                        zones.append(addResult(rs.id, desc, rs.id))\r\n                    }\r\n                }\r\n                var links = resultDiv.find(\".download-results\");\r\n                var csvNames = res.csvs.split(',');\r\n\r\n                links.find('.csv1').attr('href', '/mysql/csv/' + csvNames[0]);\r\n                links.find('.csv2').attr('href', '/mysql/csv/' + csvNames[1]);\r\n                links.show();\r\n                searchLayerControl.show(res.rows[0], res.rows[1]);\r\n            })\r\n\r\n            function addResult(title, desc, popid) {\r\n                return $('<a>').attr({ 'class': 'result', 'data-popid': popid })\r\n                    .append($('<div>').attr('class', 'content')\r\n                        .append($('<div>').attr('class', 'title').text(title))\r\n                        .append($('<div>').attr('class', 'description').text(desc))\r\n                    ).click(function() {\r\n                        var featureId = $(this).data('popid');\r\n                        console.log(authLyrCtrl.inviewIndex);\r\n                        var flayr = authLyrs[authLyrCtrl.inviewIndex];\r\n                        var query = new Query();\r\n                        query.where = \"FID = \" + featureId;\r\n                        query.returnGeometry = true;\r\n                        query.outFields = ['*'];\r\n                        map.reorder(flayr, 100);\r\n                        flayr.queryFeatures(query).then(function(results) {\r\n                            console.log(results);\r\n                            view.popup.open({\r\n                                features: results.features,\r\n                                location: results.features[0].geometry.centroid\r\n                            });\r\n                        })\r\n                        showProj(popid);\r\n\r\n                    });\r\n            }\r\n        }\r\n\r\n        $('input.toggle.toggle-zoning').change(function() {\r\n            zoningLyrCtrl.toggle();\r\n        });\r\n\r\n        $('input.toggle.toggle-auth').change(function() {\r\n            authLyrCtrl.toggle();\r\n        });\r\n\r\n        $('select[name=authLyr]').change(function() {\r\n            authLyrCtrl.switchTo($(this).val());\r\n        });\r\n\r\n        $('#searchDiv i.icon.remove').click(searchLayerControl.clear);\r\n\r\n        $('.title.item.statistic.proj').click(setVSField);\r\n\r\n        function setVSField() {\r\n            if ($(this).hasClass('active')) {\r\n                clear();\r\n            } else {\r\n                VsCtrl.setUp($(this));\r\n                $(this).unbind('click', setVSField);\r\n                $(this).find('.checkbox.allin').checkbox('check');\r\n            }\r\n        }\r\n\r\n        $('.vs-selection .checkbox.allin').checkbox().checkbox({\r\n            onChecked: function() {\r\n                var vss = $(this).parent('.checkbox').parent('.vs-selection');\r\n                vss.find('.checkbox:not(.allin)').checkbox('check');\r\n            },\r\n            onUnchecked: function() {\r\n                var vss = $(this).parent('.checkbox').parent('.vs-selection');\r\n                vss.find('.checkbox:not(.allin)').checkbox('uncheck');\r\n            }\r\n        }).checkbox('check');\r\n\r\n        $('.vs-selection .checkbox:not(.allin)').checkbox().checkbox({\r\n            onChecked: function() {\r\n                VsCtrl.addLyr($(this).data('id'));\r\n            },\r\n            onUnchecked: function() {\r\n                VsCtrl.removeLyr($(this).data('id'));\r\n            }\r\n        }).checkbox('check');\r\n\r\n    });\r\n\r\n    function showCoordinates(evt) {\r\n        $('#esri_widgets_Attribution_0 > div.esri-attribution__sources').html(evt.mapPoint.latitude + evt.mapPoint.longitude)\r\n    }\r\n});\r\n"],"sourceRoot":"/source/"}